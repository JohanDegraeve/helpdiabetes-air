<?xml version="1.0" encoding="utf-8"?>
<!--
Copyright (C) 2011  hippoandfriends

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/gpl.txt>.

-->
<s:View xmlns:fx="http://ns.adobe.com/mxml/2009" 
		xmlns:s="library://ns.adobe.com/flex/spark"
		initialize="init()"
		backKeyPressed="onBackKeyPressed(event)">
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	<fx:Script>
		<![CDATA[
			import databaseclasses.Settings;
			import databaseclasses.UnitChangedEvent;
			
			import model.ModelLocator;
			
			import mx.collections.ArrayCollection;
			import mx.core.UIComponent;
			import mx.managers.PopUpManager;
			import mx.resources.ResourceManager;
			
			import myComponents.elementFromListPicker;
			
			import spark.events.IndexChangeEvent;
			
			private var elementPicker:elementFromListPicker;
			
			[ResourceBundle("settingsview")]
			
			private var menuList:ArrayCollection = 	new ArrayCollection([
				ResourceManager.getInstance().getString("settingsview","bolus_calculation"),
				ResourceManager.getInstance().getString("settingsview","meal_times"),
				ResourceManager.getInstance().getString("settingsview","bloodglucoseunit"),
				ResourceManager.getInstance().getString("settingsview","medicin"),
				ResourceManager.getInstance().getString("settingsview","exercise"),
				ResourceManager.getInstance().getString("settingsview","database"),
				ResourceManager.getInstance().getString("settingsview","language")
			]);	
			
			private function onBackKeyPressed(event:Event):void {
				if (elementPicker != null) {
					if (elementPicker.isPopUp) {
						PopUpManager.removePopUp(elementPicker);
						event.preventDefault();
					}
					elementPicker = null;
				} 
			}
			
			private function init():void {
				/* add event listener for clicking item */
				settingsList.addEventListener(Event.CHANGE,selectedElementChanged);
				title =  ResourceManager.getInstance().getString("settingsview","settings");
			}
			
			private function selectBloodGlucoseUnit():void {
				var unitList:ArrayCollection = new ArrayCollection();
				unitList .addItem(ResourceManager.getInstance().getString("general","mgperdl"));
				unitList .addItem(ResourceManager.getInstance().getString("general","mmoll"));
				
				elementPicker = new elementFromListPicker();
				elementPicker.addEventListener(UnitChangedEvent.ITEM_SELECTED, selectedUnitChanged);
				elementPicker.elements = unitList;
				elementPicker.labelText1 = resourceManager.getString('settingsview','currentunit') + 
					resourceManager.getString('general',Settings.getInstance().getSetting(Settings.SettingsBLOODGLUCOSE_UNIT));
				elementPicker.labelText2 = resourceManager.getString('settingsview','selectnewunit');
				
				PopUpManager.addPopUp(elementPicker,UIComponent(this.parentApplication),true);
				PopUpManager.centerPopUp(elementPicker);
				
				function selectedUnitChanged(event:UnitChangedEvent):void {
					elementPicker.removeEventListener(UnitChangedEvent.ITEM_SELECTED,selectedUnitChanged);
					PopUpManager.removePopUp(elementPicker);
					if (event.index == 0)
						Settings.getInstance().setSetting(Settings.SettingsBLOODGLUCOSE_UNIT,"mgperdl");
					else if (event.index == 1)
						Settings.getInstance().setSetting(Settings.SettingsBLOODGLUCOSE_UNIT,"mmoll");
					settingsList.selectedIndex = -1;
				}
			}
			
			/**
			 * will popup a view corresponding to the selected menu
			 */
			private function selectedElementChanged(event:IndexChangeEvent):void {
				switch (event.newIndex) {
					case 0:
						navigator.pushView(SettingsBolusCalculationView);
						break;
					case 1:
						navigator.pushView(SettingsMealTimesView);
						break;
					case 2:
						settingsList.selectedIndex = -1;
						selectBloodGlucoseUnit();
						break;
					case 3:
						navigator.pushView(SettingsMedicinView);
						break;
					case 4:
						navigator.pushView(SettingsExerciseView);
						break;
					case 5:
						navigator.pushView(SettingsDatabaseView);
						break;
					case 6:
						elementPicker = new elementFromListPicker();
						elementPicker.elements = new ArrayCollection([
							resourceManager.getString('general','english'),
							resourceManager.getString('general','dutch')]);
						elementPicker.addEventListener(UnitChangedEvent.ITEM_SELECTED, languageSelected);
						//elementPicker.addEventListener(Event.REMOVED_FROM_STAGE,onReturn);
						elementPicker.labelText1 = resourceManager.getString('general','choose_language');
						
						PopUpManager.addPopUp(elementPicker,UIComponent(this.parentApplication),true);
						PopUpManager.centerPopUp(elementPicker);
						break;
				}
				
				function languageSelected(event: Event = null): void
				{
					if (elementPicker != null) {
						if (elementPicker.hasEventListener(UnitChangedEvent.ITEM_SELECTED)) {
							elementPicker.removeEventListener(UnitChangedEvent.ITEM_SELECTED, languageSelected);
						}
						PopUpManager.removePopUp(elementPicker);
					}
					
					var localeChainAsString:String;
					//copied some code from HelpDiabetes.mxml
					if (event is UnitChangedEvent)  {
						if ((event as UnitChangedEvent).index == 0) {
							resourceManager.localeChain = ["en_US","nl_NL"];
							localeChainAsString = "en_US,nl_NL";
						}
						if ((event as UnitChangedEvent).index == 1) {
							resourceManager.localeChain = ["nl_NL","en_US"];
							localeChainAsString = "nl_NL,en_US";
						}
					}
					//Settings gets the value just determined here above, in any case if the database would already be existing, the localechain from database will be taken and the Settings value will again be overwritten
					Settings.getInstance().setSetting(Settings.SettingsLOCALECHAIN_asString,localeChainAsString);
					
					//also reset the labels in the tabs
					ModelLocator.getInstance().resetLabels();
				}
			}
		]]>
	</fx:Script>
	<s:List id="settingsList" left="0" right="0" top="0" bottom="0" itemRenderer="myComponents.MenuElementItemRenderer"
			dataProvider="{menuList}">
	</s:List>
</s:View>
