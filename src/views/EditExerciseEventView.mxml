<?xml version="1.0" encoding="utf-8"?>
<!--
Copyright (C) 2011  hippoandfriends

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/gpl.txt>.

-->
<s:View xmlns:fx="http://ns.adobe.com/mxml/2009" 
		xmlns:s="library://ns.adobe.com/flex/spark" title="EditExerciseEventView"
		initialize="onInitialize()"
		backKeyPressed="onBackKeyPressed(event)">
	<fx:Declarations>
		<s:DateTimeFormatter id="dateformatter" dateTimePattern="{resourceManager.getString('general','datepattern')}" useUTC="false" locale="{Capabilities.language.substr(0,2)}"/>
		<s:DateTimeFormatter id ="timeformatter" dateTimePattern="{resourceManager.getString('general','timepattern')}" useUTC="false"/>
	</fx:Declarations>
	<fx:Metadata>
		[ResourceBundle("editexerciseeventview")]
	</fx:Metadata>
	<fx:Script>
		<![CDATA[
			import databaseclasses.ExerciseEvent;
			import databaseclasses.Settings;
			import databaseclasses.UnitChangedEvent;
			
			import model.ModelLocator;
			
			import mx.collections.ArrayCollection;
			import mx.core.UIComponent;
			import mx.managers.PopUpManager;
			
			import myComponents.DatePicker;
			import myComponents.DayLineWithTotalAmount;
			import myComponents.PickerEvent;
			import myComponents.TimePicker;
			import myComponents.elementFromListPicker;
			
			private var exercisePicker:elementFromListPicker;
			private var dateOrTimePicker:Group;
			
			[Bindable]
			private var exerciseName:String;
			[Bindable]
			private var dateText:String ;
			[Bindable]
			private var timeText:String;
			
			private var _currentDateAndTime:Date;
			private function get currentDateAndTime():Date
			{
				return _currentDateAndTime;
			}
			private function set currentDateAndTime(value:Date):void
			{
				_currentDateAndTime = value;
				dateText = dateformatter.format(_currentDateAndTime);
				timeText = timeformatter.format(_currentDateAndTime);
			}
			
			
			private function onBackKeyPressed(event:Event):void {
				if (exercisePicker != null) {
					if (exercisePicker.isPopUp) {
						PopUpManager.removePopUp(exercisePicker);
						event.preventDefault();
					}
					exercisePicker = null;
				} 
				if (dateOrTimePicker != null) {
					if (dateOrTimePicker.isPopUp) {
						PopUpManager.removePopUp(dateOrTimePicker);
						event.preventDefault();
					}
					dateOrTimePicker = null;
				} 
			}
			
			private function onInitialize():void {
				currentDateAndTime = new Date();
				dateText = dateformatter.format(_currentDateAndTime);
				timeText = timeformatter.format(_currentDateAndTime);
				exerciseName = Settings.getInstance().getSetting(parseInt(Settings.getInstance().getSetting(Settings.SettingsDefaultExercise)));
			}
			
			private function exerciseGroupClicked(e:MouseEvent = null):void {
				var unitList:ArrayCollection = new ArrayCollection();
				for (var i:int = Settings.SettingsExerciseType1; i <= Settings.SettingsExerciseType5;i++) {
					if (Settings.getInstance().getSetting(i) != null)
						if (Settings.getInstance().getSetting(i) != "")
							unitList.addItem(Settings.getInstance().getSetting(i));
				}
				
				exercisePicker = new elementFromListPicker();
				exercisePicker.addEventListener(UnitChangedEvent.ITEM_SELECTED, exerciseSelected);
				exercisePicker.elements = unitList;
				exercisePicker.labelText1 = resourceManager.getString('editexerciseeventview','select_exercise');
				
				PopUpManager.addPopUp(exercisePicker,UIComponent(this.parentApplication),true);
				PopUpManager.centerPopUp(exercisePicker);
				
				function exerciseSelected(event:UnitChangedEvent):void {
					exercisePicker.removeEventListener(UnitChangedEvent.ITEM_SELECTED,exerciseSelected);
					PopUpManager.removePopUp(exercisePicker);
					exerciseName = Settings.getInstance().getSetting(Settings.SettingsExerciseType1 + event.index);
				}
			}
			
			private function datumClicked(e:MouseEvent = null):void {
				dateOrTimePicker  = new DatePicker();
				(dateOrTimePicker as DatePicker).currentDate = currentDateAndTime;
				dateOrTimePicker.addEventListener(PickerEvent.PICKER_SET, onTimeOrDateSet);
				dateOrTimePicker.addEventListener(PickerEvent.PICKER_CANCEL, onTimeOrDateCancel);
				PopUpManager.addPopUp(dateOrTimePicker, this, true);
				PopUpManager.centerPopUp(dateOrTimePicker);
			}
			
			private function onTimeOrDateCancel(event: PickerEvent): void
			{
				dateOrTimePicker.removeEventListener(PickerEvent.PICKER_SET, onTimeOrDateSet);
				dateOrTimePicker.removeEventListener(PickerEvent.PICKER_CANCEL, onTimeOrDateCancel);
			}
			
			private function onTimeOrDateSet(event: PickerEvent): void
			{
				dateOrTimePicker.removeEventListener(PickerEvent.PICKER_SET, onTimeOrDateSet);
				dateOrTimePicker.removeEventListener(PickerEvent.PICKER_CANCEL, onTimeOrDateCancel);
				currentDateAndTime = (event.newValue as Date);
			}
			
			private function timeClicked(e:MouseEvent = null):void {
				dateOrTimePicker = new TimePicker();
				(dateOrTimePicker as TimePicker).currentTime = currentDateAndTime;
				dateOrTimePicker.addEventListener(PickerEvent.PICKER_SET, onTimeOrDateSet);
				dateOrTimePicker.addEventListener(PickerEvent.PICKER_CANCEL, onTimeOrDateCancel);
				PopUpManager.addPopUp(dateOrTimePicker, this, true);
				PopUpManager.centerPopUp(dateOrTimePicker);
			}
			
			private function okClicked(e:MouseEvent = null):void {
				var newExerciseEvent:ExerciseEvent = new ExerciseEvent(
					exerciseName,
					"",//empty comment
					currentDateAndTime.valueOf());
				ModelLocator.getInstance().trackingList.addItem(newExerciseEvent);
				
				var creationTimeStampAsDate:Date = new Date(newExerciseEvent.timeStamp);
				var creationTimeStampAtMidNight:Number = (new Date(creationTimeStampAsDate.fullYearUTC,creationTimeStampAsDate.monthUTC,creationTimeStampAsDate.dateUTC,0,0,0,0)).valueOf();
				if (creationTimeStampAtMidNight > ModelLocator.getInstance().oldestDayLineStoredInTrackingList) {
					ModelLocator.getInstance().oldestDayLineStoredInTrackingList = creationTimeStampAtMidNight;
					if (ModelLocator.getInstance().youngestDayLineStoredInTrackingList == 5000000000000)
						ModelLocator.getInstance().youngestDayLineStoredInTrackingList = creationTimeStampAtMidNight;
				} else if (creationTimeStampAtMidNight < ModelLocator.getInstance().youngestDayLineStoredInTrackingList) {
					ModelLocator.getInstance().youngestDayLineStoredInTrackingList = creationTimeStampAtMidNight;
					if (ModelLocator.getInstance().oldestDayLineStoredInTrackingList == 0)
						ModelLocator.getInstance().oldestDayLineStoredInTrackingList = creationTimeStampAtMidNight;
				}
				var oldest:Number = (new Date(ModelLocator.getInstance().oldestDayLineStoredInTrackingList)).valueOf();
				var youngest :Number = (new Date(ModelLocator.getInstance().youngestDayLineStoredInTrackingList)).valueOf();
				//Now add list of daylines
				for (var counter:Number = youngest;counter - 1 < oldest;counter = counter + 86400000)
					ModelLocator.getInstance().trackingList.addItem(new DayLineWithTotalAmount(counter));
				
				ModelLocator.getInstance().trackingList.refresh();
				navigator.popView();
			}
		]]>
	</fx:Script>
	<s:navigationContent>
		<s:Button   label="Back" id="backButton" click="navigator.popView()"/>
	</s:navigationContent>
	<s:Group y="0" x="0" width="100%" height = "100%" left="5" top="5" right="5">
		<s:layout>
			<s:VerticalLayout>
			</s:VerticalLayout>
		</s:layout>
		<s:TextArea y="0" x="0" width="100%" text="{resourceManager.getString('editexerciseeventview','addexerciseevent')}" borderVisible="false" editable="false"/>
		<s:Group id="exerciseGroup" y="0" x="0" width="100%" click="exerciseGroupClicked(event)">
			<s:layout>
				<s:HorizontalLayout>
				</s:HorizontalLayout>
			</s:layout>
			<s:TextArea  id="intensity"  width="30%" text="{resourceManager.getString('editexerciseeventview','intensity')}" editable="false" borderVisible="false"/>
			<s:TextArea id="exerciseNameTextField" width="70%" text="@{exerciseName}" editable="false" borderVisible="false" textAlign="center"/>
		</s:Group>
		<s:Group id="datumGroup" y="0" x="0" width="100%" click="datumClicked(event)">
			<s:layout>
				<s:HorizontalLayout>
				</s:HorizontalLayout>
			</s:layout>
			<s:TextArea  id="datumtext"  width="30%" text="{resourceManager.getString('general','date')}" editable="false" borderVisible="false"/>
			<s:TextArea id="datum" width="70%" text="@{dateText}" editable="false" borderVisible="false" textAlign="center"/>
		</s:Group>
		<s:Group id="timeGroup" y="0" x="0" width="100%" click="timeClicked(event)">
			<s:layout>
				<s:HorizontalLayout>
				</s:HorizontalLayout>
			</s:layout>
			<s:TextArea  id="timetext"  width="30%" text="{resourceManager.getString('general','time')}" editable="false" borderVisible="false"/>
			<s:TextArea id="time" width="70%" text="@{timeText}" editable="false" borderVisible="false" textAlign="center"/>
		</s:Group>
		<s:Group id="okGroup" y="0" x="0" width="100%" click="okClicked(event)">
			<s:TextArea  id="okButton"  textAlign="center" width="100%" text="{resourceManager.getString('addfooditemview','add_button')}" editable="false" borderVisible="false"/>
		</s:Group>
	</s:Group>
</s:View>
